<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ä½ è¦ºå¾—ä»–è®šå—ï¼Ÿ</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#0b1220;
      --muted:#475569;
      --card:#ffffff;
      --line:#e5e7eb;
      --accent:#0ea5a3;
      --danger:#ef4444;
    }
    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",Roboto,Helvetica,Arial;font-size:20px;line-height:1.5}
    .wrap{min-height:100%;display:flex;flex-direction:column}
    header{padding:16px;text-align:center;font-weight:800;letter-spacing:.02em;color:var(--muted)}
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:16px}
    .card{width:min(960px,100%);background:var(--card);border:1px solid var(--line);border-radius:20px;padding:24px;box-shadow:0 10px 30px rgba(41,56,78,.06)}
    .center{display:flex;align-items:center;justify-content:center;text-align:center}

    .headline{font-weight:900;line-height:1.15;margin:8px auto 12px;color:#0f172a}
    .headline span{font-size:clamp(26px,6vw,52px)}
    .headline .big-like{font-size:clamp(72px,16vw,160px);color:var(--accent);text-shadow:0 10px 28px rgba(14,165,163,.28)}

    .sub{color:var(--muted);font-size:18px;margin-top:6px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:700px){.grid{grid-template-columns:1fr 1fr}}

    .panel{background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid var(--line);border-radius:16px;padding:16px}
    .timer{font-variant-numeric:tabular-nums;font-size:clamp(32px,7vw,56px);font-weight:900;color:#0f766e}
    .counts{display:flex;justify-content:center;gap:18px;font-size:clamp(24px,6vw,40px);font-weight:900}
    .counts .like{color:#0f766e}

    .btn{appearance:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation;cursor:pointer;border:none;border-radius:18px;padding:18px 16px;width:100%;font-size:clamp(24px,6vw,40px);font-weight:900;letter-spacing:.02em;display:flex;align-items:center;justify-content:center;gap:10px;transition:transform .06s ease,filter .2s ease,box-shadow .2s}
    .btn:active{transform:scale(.98)}
    .btn[disabled]{opacity:.4;filter:grayscale(.1);cursor:not-allowed}

    .btn-like{background:linear-gradient(180deg,var(--accent),#19b7b3);color:#062b29;box-shadow:0 6px 16px rgba(14,165,163,.28)}
    .btn-dislike{background:linear-gradient(180deg,var(--danger),#e24646);color:#4a1010;box-shadow:0 6px 16px rgba(239,68,68,.25)}

    .two-col{display:grid;grid-template-columns:2fr 1fr;gap:14px}

    @keyframes wiggle{0%{transform:translateY(0) rotate(0)}25%{transform:translateY(-1px) rotate(-.8deg)}50%{transform:translateY(0) rotate(.5deg)}75%{transform:translateY(1px) rotate(-.5deg)}100%{transform:translateY(0) rotate(0)}}
    .shake{animation:wiggle 1200ms ease-in-out infinite}
    @media (prefers-reduced-motion:reduce){.shake{animation:none}}

    .hidden{display:none}
    .row{display:flex;align-items:center;justify-content:center;gap:10px}
    .input{width:100%;border-radius:12px;background:#ffffff;border:1px solid var(--line);padding:16px 14px;color:var(--fg);font-size:18px}
    .small{font-size:16px;color:var(--muted)}
    .toolbar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .tool{padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--fg);font-weight:800;cursor:pointer;box-shadow:0 4px 10px rgba(15,118,110,.05)}
  </style>
</head>
<body>
<div class="wrap">
  <header>ä½ è¦ºå¾—ä»–è®šå—ï¼Ÿï½œè¡Œå‹•æŠ•ç¥¨</header>
  <main>
    <div class="card">

      <!-- èµ·å§‹ç•«é¢ -->
      <section id="startScreen">
        <div class="center">
          <div>
            <div class="headline">
              <span>ä½ è¦ºå¾—ä»–</span>
              <span class="big-like">è®š</span>
              <span>å—ï¼Ÿ</span>
            </div>
            <p class="sub">è¼¸å…¥ææ¡ˆäººç·¨è™Ÿï¼ŒæŒ‰ã€Œé–‹å§‹æŠ•ç¥¨ã€å³å¯æŠ•ç¥¨ï¼</p>
          </div>
        </div>
        <div class="panel" style="margin-top:12px">
          <div class="row" style="gap:12px; flex-wrap:wrap">
            <input id="roomIdInput" class="input" placeholder="ææ¡ˆäººç·¨è™Ÿï¼ˆè«‹è¼¸å…¥å¾Œå†æŒ‰é–‹å§‹æŠ•ç¥¨ï¼‰" inputmode="latin" autocomplete="off" />
            <button id="startBtn" class="tool" style="background:linear-gradient(180deg,#eafff8,#ffffff);border-color:#bfeee0">é–‹å§‹æŠ•ç¥¨</button>
          </div>
          <div class="small" id="roomHint" style="text-align:center;margin-top:8px">ç›®å‰ææ¡ˆäººç·¨è™Ÿï¼š<b id="roomLabel">default</b></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <div class="toolbar center">
            <button id="exportBtn_start" class="tool">åŒ¯å‡º CSV</button>
          </div>
          <div class="small center">ä¸»æŒ/è©•å¯©å¯éš¨æ™‚åŒ¯å‡ºç›®å‰çµ±è¨ˆ</div>
        </div>
      </section>

      <!-- æŠ•ç¥¨ç•«é¢ -->
      <section id="voteScreen" class="hidden">
        <div class="center">
          <div>
            <div class="headline">
              <span>ä½ è¦ºå¾—ä»–</span>
              <span class="big-like">è®š</span>
              <span>å—ï¼Ÿ</span>
            </div>
            <div class="sub">ææ¡ˆäººç·¨è™Ÿï¼š<b id="roomIdText">default</b> ï½œ å‰©é¤˜æ™‚é–“</div>
          </div>
        </div>

        <div class="grid" style="margin-top:10px">
          <div class="panel center">
            <div class="timer"><span id="countdown">10</span>s</div>
            <div class="counts" style="margin-top:6px">
              <div class="like" style="font-size:clamp(32px,9vw,64px)">ğŸ‘ <span id="likeCount">0</span></div>
            </div>
            <div class="small" id="statusLine" style="margin-top:6px;font-size:18px">å³æ™‚æ›´æ–°</div>
          </div>
          <div class="panel">
            <div class="two-col">
              <button id="likeBtn" class="btn btn-like shake" aria-label="è®š" style="font-size:clamp(28px,8vw,64px);padding:22px 18px">ğŸ‘ è®š</button>
              <button id="dislikeBtn" class="btn btn-dislike shake" aria-label="ä¸è®š" style="font-size:clamp(18px,5vw,28px);padding:18px 14px">ğŸ‘ ä¸è®š</button>
            </div>
          </div>
        </div>

        <div class="toolbar" style="margin-top:10px">
          <button id="exportBtn" class="tool">åŒ¯å‡º CSV</button>
          <button id="roundBtn" class="tool">é–‹å§‹æ–°å›åˆ</button>
          <button id="backBtn" class="tool">è¿”å›é¸æ“‡ææ¡ˆäºº</button>
        </div>
      </section>

    </div>
  </main>
  <footer>é¿å…é‡è¤‡æŠ•ç¥¨ï¼šæ¯å›åˆæ¯è£ç½®åƒ…èƒ½æŠ•ä¸€æ¬¡ï¼ˆä»¥ã€Œææ¡ˆäººç·¨è™Ÿï¼‹å›åˆã€å€åˆ†ï¼‰ã€‚</footer>
</div>
<div id="toast" class="toast" role="status"></div>

<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script>
(function(){
  // ==== Firebase è¨­å®šï¼ˆRealtime Databaseï¼‰====
  const firebaseConfig = {
    apiKey: "AIzaSyAJ5exOkNx0tcGyGKd1bCWyJ4mVGqpVFos",
    authDomain: "proposal-competition.firebaseapp.com",
    databaseURL: "https://proposal-competition-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "proposal-competition",
    storageBucket: "proposal-competition.appspot.com",
    messagingSenderId: "122321094641",
    appId: "1:122321094641:web:d34d14f1e85c0b169fa650",
    measurementId: "G-R8Z1271EXG"
  };

  let db = null;
  let roomId = new URLSearchParams(location.search).get('room') || 'default';
  let countdown = 10;             // æ¯å›åˆç§’æ•¸
  let roundId = null;             // ç›®å‰å›åˆ IDï¼ˆé›²ç«¯åŒæ­¥ï¼‰
  let endAt = 0;                  // æœ¬å›åˆæˆªæ­¢æ™‚é–“ï¼ˆmsï¼‰
  let tickTimer = null;
  let voted = false;
  let offlineCounts = {like:0, dislike:0};
  const CLEAR_CODE = '1234';      // ç®¡ç†èªè­‰ç¢¼

  // å…ƒç´ 
  const startScreen = document.getElementById('startScreen');
  const voteScreen = document.getElementById('voteScreen');
  const roomLabel = document.getElementById('roomLabel');
  const roomIdInput = document.getElementById('roomIdInput');
  const roomIdText = document.getElementById('roomIdText');
  const startBtn = document.getElementById('startBtn');
  const likeBtn = document.getElementById('likeBtn');
  const dislikeBtn = document.getElementById('dislikeBtn');
  const likeCountEl = document.getElementById('likeCount');
  const countdownEl = document.getElementById('countdown');
  const statusLine = document.getElementById('statusLine');
  const exportBtn = document.getElementById('exportBtn');
  const exportBtnStart = document.getElementById('exportBtn_start');
  const backBtn = document.getElementById('backBtn');
  const roundBtn = document.getElementById('roundBtn');
  const toastEl = document.getElementById('toast');

  roomLabel.textContent = roomId;
  roomIdInput.value = '';

  // å·¥å…·
  function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1400); }
  function lsKey(){ return `voted_${roomId}_${roundId||'na'}`; }
  function setButtonsEnabled(on){ [likeBtn,dislikeBtn].forEach(b=> b.disabled = !on); }
  function now(){ return Date.now(); }
  function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

  // Firebase å•Ÿç”¨æˆ–é›¢ç·šæ¨¡å¼
  let online = false;
  try{
    if (firebaseConfig && firebaseConfig.apiKey){
      const app = firebase.initializeApp(firebaseConfig);
      db = firebase.database(app);
      online = true;
      statusLine.textContent = 'å³æ™‚æ›´æ–°ï¼ˆé›²ç«¯ï¼‰';
    } else {
      statusLine.textContent = 'æœ¬æ©Ÿç¤ºç¯„ï¼ˆæœªé€£é›²ç«¯ï¼‰';
    }
  }catch(e){
    console.warn('Firebase init failed', e);
    statusLine.textContent = 'æœ¬æ©Ÿç¤ºç¯„ï¼ˆæœªé€£é›²ç«¯ï¼‰';
  }

  // ç¶å®šé›²ç«¯ç›£è½ï¼ˆçµ±è¨ˆï¼‰
  function bindLiveCounts(){
    if(!online || !db) return;
    const countsRef = db.ref(`rooms/${roomId}/counts`);
    countsRef.on('value', snap => {
      const val = snap.val() || {like:0, dislike:0};
      likeCountEl.textContent = val.like|0;
    });
  }

  // ç¶å®šå›åˆï¼ˆä¸»æŒäººæŒ‰ã€Œé–‹å§‹æ–°å›åˆã€æœƒæ›´æ–°ï¼‰
  function bindRound(){
    if(!online || !db){
      if(!roundId){ roundId = 'local'; }
      startCountdown();
      return;
    }
    const roundRef = db.ref(`rooms/${roomId}/round`);
    roundRef.on('value', snap => {
      const val = snap.val() || {};
      const newRound = val.current || null;
      const serverEndAt = val.endAt || null;
      if(!newRound){
        statusLine.textContent = 'ç­‰å¾…ä¸»æŒäººé–‹å§‹æ–°å›åˆ';
        setButtonsEnabled(false);
        roundId = null;
        return;
      }
      const changed = newRound !== roundId;
      roundId = newRound;
      voted = !!localStorage.getItem(lsKey());
      endAt = serverEndAt || 0;
      clearInterval(tickTimer);
      if(endAt){
        tickTimer = setInterval(()=>{
          const remain = Math.ceil((endAt - now())/1000);
          const v = clamp(remain,0,10);
          countdownEl.textContent = v;
          setButtonsEnabled(!voted && v>0);
          if(v<=0){ clearInterval(tickTimer); setButtonsEnabled(false); }
        },200);
      } else if(changed){
        startCountdown();
      }
      statusLine.textContent = 'å³æ™‚æ›´æ–°';
    });
  }

  // æŠ•ç¥¨
  function vote(type){
    if(voted){ toast('æ­¤è£ç½®æœ¬å›åˆå·²æŠ•éç¥¨'); return; }
    if(now() > endAt){ toast('æœ¬å›åˆå·²çµæŸ'); return; }
    voted = true; localStorage.setItem(lsKey(),'1'); setButtonsEnabled(false);
    if(online && db){
      const ref = db.ref(`rooms/${roomId}/counts/${type}`);
      ref.transaction(cur => (cur||0) + 1);
      const log = db.ref(`rooms/${roomId}/logs`).push();
      log.set({t: firebase.database.ServerValue.TIMESTAMP, type, round: roundId});
    }else{
      offlineCounts[type]++; renderCounts();
    }
  }

  // ç•«é¢æ›´æ–°
  function renderCounts(){
    likeCountEl.textContent = online ? likeCountEl.textContent : offlineCounts.like;
  }

  // æœ¬åœ°å€’æ•¸ï¼ˆåƒ…é›¢ç·šæˆ–é›²ç«¯æœªæä¾› endAt æ™‚åšå¾Œå‚™ï¼‰
  function startCountdown(){
    endAt = now() + countdown*1000; countdownEl.textContent = countdown;
    setButtonsEnabled(!voted);
    clearInterval(tickTimer);
    tickTimer = setInterval(()=>{
      const remain = Math.ceil((endAt - now())/1000);
      const v = clamp(remain,0,10);
      countdownEl.textContent = v;
      if(v<=0){ clearInterval(tickTimer); setButtonsEnabled(false); }
    },200);
  }

  // åŒ¯å‡º CSV
  async function exportCSV(){
    let like = 0, dislike = 0;
    if(online && db){
      const snap = await db.ref(`rooms/${roomId}/counts`).get();
      const val = snap.val() || {like:0, dislike:0};
      like = val.like|0; dislike = val.dislike|0;
    }else{ like = offlineCounts.like; dislike = offlineCounts.dislike; }
    const ts = new Date().toISOString();
    const csv = `room,round,like,dislike,timestamp\n${roomId},${roundId||''},${like},${dislike},${ts}\n`;
    const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `vote_counts_${roomId}_${roundId||'cur'}.csv`;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // é–‹å§‹æ–°å›åˆï¼ˆä¸»æŒäººï¼‰
  async function startNewRound(){
    const code = window.prompt('è¼¸å…¥èªè­‰ç¢¼ä»¥é–‹å§‹æ–°å›åˆï¼š');
    if(code !== CLEAR_CODE){ if(code!==null) toast('èªè­‰ç¢¼éŒ¯èª¤'); return; }
    const newId = 'r' + Date.now().toString(36);
    const endAtMs = Date.now() + countdown*1000;

    if(online && db){
      const updates = {};
      updates[`rooms/${roomId}/counts`] = {like:0, dislike:0};
      updates[`rooms/${roomId}/round`] = {current:newId, endAt:endAtMs};
      await db.ref().update(updates);
      toast('å·²é–‹å§‹æ–°å›åˆ');
    }else{
      offlineCounts = {like:0, dislike:0};
      roundId = newId; renderCounts();
      endAt = endAtMs; startCountdown();
      toast('å·²é–‹å§‹æ–°å›åˆï¼ˆæœ¬æ©Ÿï¼‰');
    }
  }

  // äº‹ä»¶
  startBtn.addEventListener('click', ()=>{
    const input = (roomIdInput.value||'').trim();
    if(input) roomId = input;
    document.getElementById('roomIdText').textContent = roomId;
    document.getElementById('roomLabel').textContent = roomId;
    startScreen.classList.add('hidden');
    voteScreen.classList.remove('hidden');
    bindLiveCounts();
    bindRound();
  });

  likeBtn.addEventListener('click', ()=> vote('like'));
  dislikeBtn.addEventListener('click', ()=> vote('dislike'));
  exportBtn.addEventListener('click', exportCSV);
  exportBtnStart.addEventListener('click', exportCSV);
  backBtn.addEventListener('click', ()=>{
    try{
      if(online && db){
        try{ db.ref(`rooms/${roomId}/counts`).off(); }catch(e){}
        try{ db.ref(`rooms/${roomId}/round`).off(); }catch(e){}
      }
    }catch(e){}
    clearInterval(tickTimer);
    setButtonsEnabled(false);
    voted = false; roundId = null; endAt = 0;
    voteScreen.classList.add('hidden');
    startScreen.classList.remove('hidden');
    roomIdInput.focus();
  });

  roundBtn.addEventListener('click', startNewRound);

  // é¦–æ¬¡æ¸²æŸ“ï¼ˆé›¢ç·šæ¨¡å¼å¯è¦‹ï¼‰
  renderCounts();

  /* =============================
     æ¸¬è©¦ï¼ˆåƒ…åœ¨ ?test=1 æ™‚å•Ÿç”¨ï¼‰
     ç›®çš„ï¼šåŸºæœ¬ DOM èˆ‡é›¢ç·šæŠ•ç¥¨æµç¨‹æª¢æŸ¥ã€‚
  ==============================*/
  (function runTests(){
    const usp = new URLSearchParams(location.search);
    if(usp.get('test') !== '1') return;
    const results = [];
    function t(name, fn){
      try{ fn(); results.push({name, ok:true}); }
      catch(e){ console.error('TEST FAIL:', name, e); results.push({name, ok:false, err:e}); }
    }
    t('elements-exist', ()=>{
      console.assert(startBtn && likeBtn && dislikeBtn && exportBtn && roundBtn && backBtn, 'å¿…éœ€æŒ‰éˆ•ä¸å­˜åœ¨');
      console.assert(roomIdInput && roomIdText && likeCountEl && countdownEl, 'å¿…éœ€å…ƒç´ ä¸å­˜åœ¨');
    });
    t('clear-code', ()=>{ console.assert(CLEAR_CODE === '1234', 'èªè­‰ç¢¼é 1234'); });
    t('lsKey-has-round', ()=>{ roundId = 'RTEST'; console.assert(lsKey().includes('RTEST'), 'lsKey æœªå«å›åˆ'); });
    t('offline-increment', ()=>{
      if(!online){
        const beforeLike = Number(likeCountEl.textContent)||0;
        vote('like');
        const afterLike = Number(likeCountEl.textContent)||0;
        console.assert(afterLike === beforeLike + 1 || voted, 'é›¢ç·šæŒ‰è®šæœªéå¢');
      }
    });
    t('countdown-range', ()=>{
      startCountdown();
      const v = Number(countdownEl.textContent);
      console.assert(v >= 0 && v <= 10, 'å€’æ•¸è¶…å‡ºç¯„åœ');
    });
    t('firebase-paths', ()=>{
      if(online){
        const p1 = `rooms/${roomId}/counts`;
        const p2 = `rooms/${roomId}/round`;
        console.assert(p1.includes('rooms/') && p2.includes('rooms/'), 'ç›£è½è·¯å¾‘éŒ¯èª¤');
      }
    });
    console.table(results);
  })();
})();
</script>

<!-- ä½¿ç”¨èªªæ˜ï¼ˆå¯åˆªï¼‰
1) èµ·å§‹ï¼šè¼¸å…¥ææ¡ˆäººç·¨è™Ÿ â†’ é–‹å§‹æŠ•ç¥¨ã€‚
2) å›åˆï¼šä¸»æŒäººæŒ‰ã€Œé–‹å§‹æ–°å›åˆã€â†’ è¼¸å…¥ 1234 â†’ é‡è¨­çµ±è¨ˆä¸¦åŒæ­¥ 10 ç§’å€’æ•¸ã€‚
3) è¦å‰‡ï¼šæ¯å›åˆæ¯è£ç½®åƒ…èƒ½æŠ•ä¸€æ¬¡ï¼›æœªé–‹å›åˆæ™‚é¡¯ç¤ºç­‰å¾…ä¸»æŒäººã€‚
4) åŒ¯å‡ºï¼šCSV æ¬„ä½ room,round,like,dislike,timestampã€‚
5) æ¸¬è©¦ï¼šç¶²å€åŠ ä¸Š ?test=1 å¯æ–¼ Console çœ‹åˆ°æ¸¬è©¦çµæœã€‚
-->
</body>
</html>
